1. Think for yourself in English, but provide answers in Russian.
2. Для сложных правок, затрагивающих несколько файлов или содержащих комплексную логику, сначала формируй и представляй план действий. Приступай к реализации только после его одобрения. Это обеспечит атомарность и взвешенность твоих правок.
3. Соблюдай стиль кода. Весь генерируемый или изменяемый тобой код на Python должен быть отформатирован с помощью `black` и проходить проверку линтером `flake8` без ошибок.
4. При добавлении нового функционала или изменении существующего, всегда обновляй сопутствующую документацию (например, в файле `documentation/instructions.md`), чтобы она отражала внесенные изменения.

# Telegram-бот для игры в "Дурака"
Это Telegram-бот для игры в карточную игру "Дурак".
## Установка и запуск
1.  **Установите зависимости:**

    ```bash
    pip install -r requirements.txt
    ```
2.  **Настройте переменные окружения:**
    Создайте файл `.env` в корневой директории проекта и добавьте в него следующие переменные:
    ```
    BOT_TOKEN=ВАШ_ТОКЕН_БОТА
    ADMINS=ВАШ_ТЕЛЕГРАМ_ID
    ```
    *   `BOT_TOKEN`: токен вашего Telegram-бота.
    *   `ADMINS`: ваш Telegram ID в качестве администратора бота.

3.  **Запустите бота:**

    ```bash
    python bot.py
    ```
    Или воспользуйтесь скриптами для запуска:
    *   Для Windows: `start.bat`
    *   Для Linux/macOS: `start.sh`

## Структура проекта

*   `main.py`: Файл-заглушка. На данный момент содержит только тестовый вывод в консоль и не используется в основной логике бота.
*   `bot.py`: Основная точка входа в приложение. Этот файл отвечает за запуск и первоначальную настройку Telegram-бота. Он импортирует и регистрирует все обработчики команд, устанавливает команды меню бота и запускает `polling` для получения обновлений от Telegram.
*   `loader.py`: Важный файл для инициализации ключевых компонентов. Он создает и настраивает подключение к базе данных, инициализирует `GameManager` для управления игровыми сессиями, а также создает единые экземпляры бота (`Bot`) и диспетчера (`Dispatcher`) из библиотеки `aiogram`, которые затем используются во всем приложении.
*   `config.py`: Центральный файл конфигурации. Он загружает переменные окружения (токен, ID администраторов) с помощью `python-dotenv`, определяет игровые константы (время ожидания, макс. игроков) и перечисляет все команды бота в удобной структуре `Commands` для автодополнения и управления.
*   `requirements.txt`: Стандартный файл, перечисляющий все библиотеки Python, необходимые для работы проекта. Установка зависимостей производится командой `pip install -r requirements.txt`.
*   `pyproject.toml`: Файл конфигурации для инструментов разработки Python. В данном проекте он используется для настройки форматера `black` и линтера `flake8`, обеспечивая единый стиль кода.
*   `start.bat`: Простой пакетный скрипт для запуска бота в операционных системах Windows. Устанавливает заголовок окна консоли и выполняет `python bot.py`.
*   `start.sh`: Shell-скрипт для запуска бота в Unix-подобных системах (Linux, macOS). Делает то же самое, что и `.bat` версия, но с использованием синтаксиса bash.
*   `durak/`: Главный пакет, содержащий всю бизнес-логику игры "Дурак".
    *   `db/`: Модули для работы с базой данных с использованием Pony ORM.
        *   `__init__.py`: Экспортирует модель `UserSetting` и объект `session` для удобного импорта в других частях приложения.
        *   `database.py`: Создает и экспортирует синглтон `db = Database()` от Pony ORM, который представляет собой подключение к базе данных. Также экспортирует `session`, являющийся псевдонимом для `db_session`, который используется для работы с сессиями базы данных.
        *   `user_settings.py`: Определяет сущность (модель) `UserSetting` для базы данных. Эта модель хранит настройки и статистику игрока, включая его Telegram ID, количество побед, сыгранных игр и другие игровые метрики.
    *   `handlers/`: Обработчики команд и callback-запросов от пользователей в Telegram.
        *   `game/`: Обработчики, отвечающие за игровой процесс. Каждый файл обрабатывает определенную команду или действие:
            *   `auto_leave.py`: Автоматически удаляет из игры участника, покинувшего Telegram-группу.
            *   `callback_handlers.py`: Обрабатывает нажатия на инлайн-кнопки "Присоединиться" и "Начать игру".
            *   `chosing.py`: Основной файл для взаимодействия с игроком во время хода. Через инлайн-режим показывает карты и доступные действия (атака, защита, пас).
            *   `global_leave.py`: Реализует команду `/gleave` для выхода из игры, даже если команда отправлена из другого чата.
            *   `join.py`: Обрабатывает команду `/join` для входа в игровое лобби.
            *   `join_inline.py`: Отвечает за инлайн-режим присоединения к игре. (Примечание: функционал может быть неполным).
            *   `kick.py`: Обрабатывает команду `/kick` для исключения игрока из игры.
            *   `kill.py`: Реализует команду `/kill` для досрочного завершения игры создателем или администратором.
            *   `leave.py`: Обрабатывает команду `/leave` для выхода игрока из текущей игры.
            *   `new.py`: Создает новую игру в чате по команде `/new` и предлагает кнопки для присоединения и старта.
            *   `process_chosen.py`: Обрабатывает выбор игрока в инлайн-режиме (атака, защита, пас), применяет игровую логику и содержит анти-чит систему.
            *   `start.py`: Запускает игру по команде `/start`, проверяя права пользователя и количество игроков.
            *   `test_win.py`: Обрабатывает команду `/test_win` для досрочного завершения игры администратором с возможностью указания победителя.
        *   `info/`: Обработчики для информационных запросов.
            *   `help.py`: Отвечает на команды `/help` и `/start_bot`, отправляя подробное руководство по игре. Описывает шаги для начала игры, правила взаимодействия через инлайн-режим и перечисляет основные команды, включая управление игрой и статистикой.
            *   `stats.py`: Управляет статистикой игроков. Обрабатывает команду `/stats` для отображения статистики (победы, количество игр, процент побед), а также команды `/on_stats` и `/off_stats` для включения или отключения сбора статистики для пользователя.
    *   `logic/`: Ключевая бизнес-логика игры.
        *   `game_manager.py`: Реализует класс `GameManager`, который служит центральным хранилищем и менеджером всех активных игровых сессий. Он управляет созданием (`new_game`), поиском (`get_game_from_chat`), завершением (`end_game`), присоединением игроков (`join_in_game`) и запуском (`start_game`) игр.
        *   `actions.py`: Содержит асинхронные функции, которые управляют основными действиями в игре. Отвечает за полный цикл хода (`do_turn`), обработку победы игрока (`win`), выход игрока из игры (`do_leave_player`), пас (`do_pass`), взятие карт со стола (`do_draw`), а также логику атаки (`do_attack_card`) и защиты (`do_defence_card`). Этот модуль является ядром игровой механики.
        *   `result.py`: Отвечает за формирование `InlineQueryResult` для ответов в инлайн-режиме Telegram. Этот модуль создает визуальные элементы, с которыми взаимодействует игрок: отображение карт (играбельных и неактивных), кнопок "Пас" (`add_pass`), "Взять" (`add_draw`), а также информационных сообщений о состоянии игры (`add_gameinfo`, `add_no_game`).
        *   `utils.py`: Набор вспомогательных функций-утилит, в основном предназначенных для проверки прав доступа. Включает функции для проверки, является ли пользователь создателем игры (`user_is_creator`), администратором бота (`user_is_bot_admin`) или администратором чата (`user_is_admin`).
    *   `objects/`: Классы, описывающие основные сущности (модели данных) игры.
        *   `card.py`: Определяет класс `Card` для представления игральной карты, а также перечисления (Enum) для мастей (`Suits`, `SuitsIcons`) и достоинств (`Values`). Содержит словари `STICKERS` с идентификаторами Telegram-стикеров для каждой карты, что позволяет отображать их в чате. Также включает вспомогательную функцию `from_str` для создания объекта `Card` из строки.
        *   `deck.py`: Реализует класс `Deck`, управляющий игровой колодой. Отвечает за создание стандартной колоды, её тасование (`shuffle`), определение козыря (`_set_trump`), раздачу карт (`draw`) и сброс отбитых карт (`dismiss`).
        *   `errors.py`: Содержит определения кастомных классов исключений (например, `DeckEmptyError`, `NoGameInChatError`), которые используются для обработки специфических игровых ситуаций и ошибок. Это помогает сделать логику более предсказуемой и управляемой.
        *   `game.py`: Содержит класс `Game` — ядро одной игровой сессии. Этот класс управляет всем состоянием игры: отслеживает игроков (`players`), колоду (`deck`), карты на игровом поле (`field`), козырь (`trump`), а также очередность ходов. Методы класса отвечают за старт игры, атаку (`attack`), защиту (`defend`), переход хода (`turn`) и пополнение рук игроков.
        *   `player.py`: Реализует класс `Player`, представляющий участника игры. Хранит информацию о пользователе Telegram (`user`) и его картах в руке (`cards`). Содержит ключевую логику для определения доступных для хода карт (`playable_card_atk`, `playable_card_def`) и правил, по которым одна карта может побить другую (`can_beat`).
*   `documentation/`: Папка с документацией проекта.
    *   `instructions.md`: Этот самый файл с инструкциями.
*   `img/`: Папка для хранения всех графических ассетов, используемых в боте. Изображения напрямую не встраиваются в код, но их идентификаторы (file_id) кешируются в `durak/objects/card.py` для быстрой отправки в виде стикеров.
    *   `logo_sticker_pack.png`: Основное изображение для стикерпака бота.
    *   `sprites.png`, `sprites_lowsat.png`: Спрайт-листы, объединяющие изображения всех карт в один файл. `lowsat` версия — с пониженной насыщенностью, используется для отображения неактивных или уже сыгранных карт.
    *   `sprite_512px/`: Содержит отдельные файлы изображений для каждой карты в высоком разрешении (512x512 пикселей).
    *   `sprites_512px_lowsat/`: Аналогично предыдущей, но с изображениями карт с пониженной насыщенностью.
    *   `special/`: Изображения для специальных игровых действий, таких как "Взять" (`draw.png`) или "Пас".

## Стиль кода

Для поддержания чистоты и единообразия кода в этом проекте используется автоматическое форматирование с помощью `black` и проверка стиля с помощью `flake8`.

## Планы на будущее

*   Добавить новые игровые режимы.
*   Улучшить искусственный интеллект ботов.
*   Добавить возможность настройки правил игры.

## Логирование и история изменений

### История изменений (`CHANGELOG.md`)

Для отслеживания всех значимых изменений в проекте используется файл `CHANGELOG.md`, расположенный в корневой директории. В нем фиксируются новые функции, исправления ошибок, изменения в конфигурации и другие важные обновления. Это помогает всем участникам разработки быть в курсе эволюции проекта.

### Логирование работы бота

Логирование — критически важный инструмент для отладки и мониторинга работы бота. Оно позволяет отслеживать ошибки, анализировать поведение пользователей и диагностировать проблемы.

Рекомендуется настроить логирование в главном файле `bot.py` с использованием стандартной библиотеки `logging`.

**Пример базовой конфигурации логирования:**

```python
import logging
import sys

# ... другие импорты

# Настройка логирования
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(name)s - %(message)s',
    handlers=[
        logging.FileHandler("bot.log"),  # Запись логов в файл
        logging.StreamHandler(sys.stdout) # Вывод логов в консоль
    ]
)

# ... остальной код в bot.py
async def main():
    # ...
    logging.info("Бот запускается...")
    await dp.start_polling(bot)

if __name__ == '__main__':
    try:
        asyncio.run(main())
    except (KeyboardInterrupt, SystemExit):
        logging.info("Бот остановлен.")
```

Эта конфигурация будет одновременно записывать все логи уровня `INFO` и выше в файл `bot.log` и выводить их в консоль.
