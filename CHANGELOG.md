# Історія змін

## [Невипущено]

### Додано
- **Файл з командами для BotFather:** Створено файл `commands.txt`, що містить список усіх команд бота та їх опис. Цей файл призначений для копіювання та вставки в налаштування команд у **@BotFather**.
- **Архітектура тем для карт:** Створено гнучку систему тем. Карти винесено з `card.py` в окрему директорію `durak/objects/decks/`. Кожна тема є `.py` файлом, що містить словник `THEME` з чотирма стилями (`normal`, `grey`, `trump_normal`, `trump_grey`).
- **Динамічне завантаження тем:** В `card.py` реалізовано механізм, який автоматично знаходить та завантажує всі доступні теми з директорії `decks` при старті бота.
- **Додано першу тему:** Створено тему `classic`, що містить оригінальні стікери карт.
- **Додано тему-заглушку:** Створено файл `green_trumps.py` як копію `classic`, що слугуватиме прикладом та основою для майбутньої стилізації козирних карт.
- Створено файл CHANGELOG.md для відстежування історії змін у проекті.
- В кінці гри тепер виводиться повідомлення зі списком переможців та програвших.
- Додано команду `/test_win` для адміністраторів, яка дозволяє миттєво завершити гру, визначивши переможця.
- **Основа для стилізації козирів:** В об'єкти карт додано нові стилі (`trump_normal`, `trump_grey`) та реалізовано логіку в `result.py` для їх вибору. Це дозволить у майбутньому візуально виділяти козирні карти.
- **Інструмент для розробки:** Додано тимчасовий обробник `get_sticker_id.py`, який дозволяє адміністраторам отримувати `file_id` будь-якого надісланого боту стікера. Функціонал захищений фільтром `is_admin`.

### Змінено
- **Повна локалізація на українську мову:** Усі повідомлення для користувачів, включаючи відповіді адміністративної команди `/test_win`, були повністю перекладені.
- **Оновлено локалізацію команд:** Описи команд у файлі `config.py` та `commands.txt` перекладено на українську мову.
- **Рефакторинг викликів команд:** Усі жорстко закодовані команди (наприклад, `'/new'`) замінено на константи з класу `Commands`, що централізувало управління та підвищило надійність.
- **Рефакторинг `card.py`:** Файл `durak/objects/card.py` було значно спрощено. Видалено жорстко закодовані словники карт (`CARDS`). Тепер змінні `CARDS` та `STICKERS` генеруються динамічно на основі активної теми (`ACTIVE_THEME`).
- Уніфіковано ігрові повідомлення для кращої консистентності. Повідомлення про перемогу, нічию та закінчення гри були приведені до єдиного стилю.
- Оновлено документацію `instructions.md`, додано розділ про ключові бібліотеки, що використовуються в проекті.
- **Покращено `/test_win`:** Команда `/test_win` тепер підтримує визначення переможця за ID користувача або через відповідь на повідомлення. Додано перевірки та інформативні повідомлення про помилки.
- **Рефакторинг коду відображення карт:** Змінено звернення зі збірного словника `STICKERS` на більш конкретні `CARDS` та `SPECIAL`. Це підвищило читабельність коду та його стійкість до потенційних конфліктів ключів.

### Виправлено
- **Виправлено логіку пасу:** Удосконалено механізм пасу. Тепер хід коректно завершується тільки тоді, коли атакуючий гравець спасував, а захисник відбив усі карти. Це усуває можливість передчасного завершення ходу та забезпечує стабільну роботу логіки.
- Видалено згадки про неіснуючі команди (`/notify_me`, `/delstats`, `/open`) з текстів допомоги та повідомлень про помилки.
- **Архітектурне виправлення:** Усунуто першопричину помилки `NameError: is_admin`. Ініціалізація `Bot` та `Dispatcher` централізована в `loader.py`. Головний файл `bot.py` тепер імпортує єдиний екземпляр `dp` і реєструє в ньому фільтр до імпорту хендлерів, що гарантує правильний порядок завантаження та усуває конфлікти.
- Виправлено критичну помилку сумісності в реалізації команди `/test_win`, замінивши синтаксис `aiogram v3` (Router) на коректний для `aiogram v2` (`@dp.message_handler`).
- **Виправлено `AttributeError` в `/test_win`:** Додано відсутній метод `player_for_id` до об'єкта `Game`, що усунуло помилку при перевірці гравця.
- **Виправлено відправку повідомлень в `/test_win`:** Виправлено помилку, через яку `GameManager` не міг надсилати повідомлення. Тепер екземпляр бота коректно передається в `GameManager` при запуску, що дозволяє команді `/test_win` успішно завершувати гру та інформувати про переможця.
- **Виправлено блокування в `/test_win`:** Усунуто проблему, через яку команда `/test_win` не завершувалася. Синхронний виклик `end_game` (який працює з базою даних) тепер виконується в окремому потоці за допомогою `asyncio.to_thread`, що запобігає блокуванню асинхронного циклу.
- **Покращено логіку `/test_win`:** Команда `/test_win` тепер коректно завершує гру, встановлюючи статус `game.started = False`, та виводить деталізоване повідомлення зі списком переможця та програвших, аналогічне стандартному завершенню гри.
- **Виправлено підключення обробників:** Відновлено коректний `__init__.py` для `durak/handlers/info`, який був помилково перезаписаний. Це запобігло відключенню команд `/help` та `/stats`.
- **Виправлено синтаксис фільтра:** У новому обробнику `get_sticker_id.py` виправлено некоректне використання фільтра `IsAdminFilter()` на правильний синтаксис `is_admin=True`, що запобігло б помилці `TypeError` при запуску бота.
- **Виправлено `AttributeError` в `test_win.py`:** Додано `TEST_WIN` до класу `Commands` в `config.py`, щоб виправити помилку `AttributeError`.

### Документація
- **Оновлено інструкцію з налаштування команд:** В `documentation/instructions.md` додано розділ "Налаштування команд бота", який пояснює, як використовувати файл `commands.txt` для налаштування команд у **@BotFather**.
- **Оновлено структуру проекту:** В `documentation/instructions.md` додано опис файлу `commands.txt`.
- **Оновлено документацію по темам:** В `documentation/instructions.md` додано вичерпний розділ "Управління темами карт", який пояснює нову архітектуру та надає інструкції по створенню та активації нових тем.
- **Оновлено структуру проекту:** Додано опис для `durak/handlers/game/admin.py` та уточнено роль `durak/logic/game_manager.py` в `documentation/instructions.md`, щоб документація відповідала актуальній кодовій базі.
- **Додано опис нового інструменту:** В `documentation/instructions.md` додано розділ "Інструменти для розробки" з описом функціоналу для отримання `file_id` стікерів.
