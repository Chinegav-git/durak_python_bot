# Історія змін

## [1.2.12] - 2024-05-27

### Fixed
- **`pony.orm.core.TransactionError` в `/gamemode`**: Виправлено помилку транзакції, перемістивши асинхронні операції (`await message.answer`) всередину блоку `with db_session` та виконуючи їх після `commit()`. Це гарантує, що транзакція завершується до призупинення функції, що усуває помилку.

## [1.2.11] - 2024-05-26

### Fixed
- **Критичні помилки в `/gamemode`**: Повністю перероблено обробник команди `/gamemode` для виправлення двох критичних помилок, що призводили до падіння.
    - **`pony.orm.core.TransactionError`**: Виправлено шляхом реструктуризації коду. Тепер асинхронні операції (відправка повідомлень) виконуються поза сесією бази даних, що запобігає конфліктам транзакцій.
    - **`aiogram.utils.exceptions.CantParseEntities`**: Виправлено помилку парсингу, замінивши символи `< >` на безпечні `[ ]` у тексті-підказці.

### Changed
- **Документація:** Оновлено файл `documentation/instructions.md`, додавши безпечний приклад звіту про помилку та актуалізувавши опис команди `/gamemode`.

## [1.2.10] - 2024-05-26

### Fixed
- **Критична помилка `ImportError`**: Виправлено помилку імпорту `session` в `durak/db/__init__.py`, яка призводила до повного падіння застосунку при старті. Це виправлення відновлює базову працездатність бота.

### Changed
- **Вдосконалено процес розробки та верифікації:**
    - Оновлено та деталізовано правила роботи AI-асистента в `documentation/instructions.md`.
    - Введено **обов'язкову чесну само-верифікацію**, яка вимагає проведення ретельного статичного аналізу коду замість неможливого в даному середовищі реального тестування. Це спрямовано на підвищення надійності та запобігання неправдивим твердженням про готовність коду.


## [1.2.9] - 2024-05-26 (Нестабільна версія)

### Fixed
- **`pony.orm.core.TransactionError` в `/gamemode`**: Виправлено помилку транзакції, замінивши декоратор `@session` на блок `with db_session:`.
- **`AttributeError: 'int' object has no attribute 'id'` в `/gamemode`**: Виправлено помилку в перевірці творця гри, забезпечивши передачу повного об'єкта `User`.
- **`AttributeError: type object 'UserSetting' has no attribute 'get_or_create'` в `test_win`**: Реалізовано метод `get_or_create` для моделі `UserSetting`.

### Changed
- **Вдосконалено процес розробки:**
    - Оновлено та деталізовано правила роботи AI-асистента в `documentation/instructions.md`.
    - Введено обов'язковий крок фінальної само-верифікації для підвищення надійності.

### Refactored
- **Стиль `CHANGELOG.md`:** Усі попередні записи були переписані для відповідності єдиному, технічно-конкретному стилю, що покращило читабельність історії змін.

## [1.2.7] - 2024-05-25

### Refactored
- **Розділено відповідальність стану гри та налаштувань:**
    - В `ChatSetting` додано поле `is_game_active` для відстеження активної ігрової сесії, що усуває конфлікт з полем `display_mode`.
    - `GameManager` тепер керує виключно `is_game_active` для початку та завершення гри.
    - `GameManager.new_game` тепер скидає `is_game_active` в `False` при запуску, якщо гра існує в БД, але відсутня в пам'яті (після перезапуску бота).

### Fixed
- **Логіка `/gamemode`:**
    - Обробник тепер використовує `CommandObject` для отримання аргументів.
    - Виклик `/gamemode` без аргументів повертає поточне значення `display_mode` з БД.
    - Виклик `/gamemode [mode]` оновлює `display_mode` в БД, зберігаючи налаштування між іграми.

### Added
- **Файл `.gitignore`:** Створено стандартний `.gitignore` для виключення кешу та системних файлів (`__pycache__`, `venv`, `.pyc`) з репозиторію.

## [1.2.6] - 2024-05-24

### Fixed
- **`AttributeError` в `Card`**: Атрибут `.rank` остаточно замінено на `.value` при перевірці можливості підкинути карту, що усунуло помилку.
- **`TypeError` в `/new`**: Виправлено помилку шляхом отримання об'єктів `chat` та `user` з `message` замість застарілого методу `get_current()`.

## [1.2.5] - 2024-05-24

### Fixed
- **`AttributeError` в `attacker_can_continue`**: Атрибут `.rank` замінено на `.value`.
- **Подвійне сповіщення:** Видалено дублюючий виклик `send_turn_notification`.
- **`TransactionError`:** Ігрові дії обгорнуто в `db_session` для запобігання помилок транзакцій.

## [1.2.4] - 2024-05-24

### Fixed
- **`KeyError: 'game'` в `/gamemode`**: Прямий доступ `dp.bot['game']` замінено на безпечний виклик `dp.bot.get('game')`.

## [1.2.3] - 2024-05-24

### Fixed
- **`ModuleNotFoundError` в `game_mode.py`**: Виправлено шляхом прямого імпорту моделі `ChatSetting` замість неіснуючого `db_api`.

## [1.2.2] - 2024-05-23

### Fixed
- **`ImportError` (aiogram v2/v3):** Код повністю адаптовано для зворотної сумісності з `aiogram` v2.

## [1.2.1] - 2024-05-23

### Fixed
- **`OperationalError: no such column`**: Виправлено помилку шляхом явного зазначення шляху до БД.
- **`NameError: Invalid filter name`**: Змінено порядок ініціалізації фільтрів для виправлення помилки `is_admin`.

## [1.2.0] - 2024-05-22

### Added
- **Новий режим гри `sticker_and_button`:** Розширено логіку в `game_mode.py` та `result.py` для підтримки режиму відображення без тексту.

## [1.1.0] - 2024-05-22

### Added
- **Керування режимами гри:** Додано команду `/gamemode` та модель `ChatSetting` для зберігання налаштувань відображення (`text`, `text_and_sticker`).
- **Візуалізація стікерами:** В `actions.py` додано логіку відправлення та видалення стікерів карт під час ходу.
- **Авто-пас:** В `actions.py` реалізовано автоматичний пас, якщо гравець відбив усі карти в грі для двох.
- **Керування повідомленнями:** Реалізовано механізм автоматичного видалення службових повідомлень.
- **Система тем:** В `objects/card.py` створено механізм для завантаження та використання тем карт.

### Changed
- **Відображення карт:** Оновлено функцію текстового представлення карт для кращої читабельності.
- **Локалізація:** Усі текстові рядки та повідомлення перекладено українською мовою.

### Fixed
- **Механіка гри:** Виправлено помилки в логіці переходу ходу та обробки пасу.
- **Інтерфейс:** Виправлено помилки в обробниках інлайн-кнопок, що відновило їх функціональність.
