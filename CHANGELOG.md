## [1.6.1] - 2024-07-23

### Refactor
- **Оптимізовано та уніфіковано структуру імпортів:** Проведено рефакторинг `__init__.py` файлів у ключових пакетах (`handlers`, `logic`, `objects`) для створення єдиних точок входу та спрощення архітектури.
    - **Що змінено:**
        1.  **Централізовано імпорти в `handlers`:** Створено `durak/handlers/__init__.py`, який збирає та експортує всі роутери з дочірніх модулів. Це дозволяє реєструвати всі обробники в `bot.py` одним імпортом.
        2.  **Спрощено доступ до бізнес-логіки:** Файл `durak/logic/__init__.py` тепер експортує ключові класи та функції (`GameManager`, `GameActions`, `send_message`), що робить їх доступними з єдиного простору імен.
        3.  **Структуровано моделі даних:** В `durak/objects/__init__.py` прописано експорт основних ігрових сутностей (`Game`, `Player`, `Deck`, `Card`, `Suits`, `Values`), що формалізує "публічний API" цього пакету.
        4.  **Динамічне завантаження тем:** Створено `durak/objects/decks/__init__.py`, який автоматично знаходить та завантажує всі доступні теми карт, роблячи систему розширюваною.
    - **Чому це важливо:** Цей рефакторинг робить структуру проекту більш чистою, логічною та простою для розуміння. Він усуває складні відносні імпорти в коді, зменшує кількість "брудних" `sys.path.append` і полегшує подальшу підтримку та розширення кодової бази.

## [1.6.0] - 2024-07-22

### Refactor
- **Уніфікація конфігурації та підготовка до переходу на PostgreSQL:** Проведено комплексний рефакторинг для централізації налаштувань, усунення архітектурних протиріч та підготовки проекту до безшовної міграції з SQLite на PostgreSQL.
    - **Що змінено:**
        1.  **Централізація конфігурації БД:** У файл `config.py` додано зчитування змінної `DATABASE_URL` з оточення. Тепер це єдине джерело налаштувань бази даних.
        2.  **Адаптація `Tortoise ORM`:** Конфігурація `durak/db/tortoise_config.py` тепер використовує `DATABASE_URL` з `config.py` замість жорстко закодованого шляху до SQLite.
        3.  **Оновлення життєвого циклу:** Логіка ініціалізації (`init_db`) та закриття з'єднань (`close_db_connection`) була перенесена безпосередньо в `bot.py` і прив'язана до подій `startup` та `shutdown` диспетчера. Це забезпечує коректне керування підключенням до БД.
        4.  **Видалення застарілого `loader.py`:** Файл `loader.py` був повністю видалений, оскільки його функціонал став надлишковим. Ініціалізація бота, диспетчера та сховища тепер відбувається безпосередньо в `bot.py`.
        5.  **Перехід на `RedisStorage`:** FSM-сховище було переведено з `MemoryStorage` на `RedisStorage`, що відповідає загальній архітектурі проекту, яка вже використовує Redis для зберігання стану ігор. Це підвищує надійність збереження станів діалогів.
    - **Чому це важливо:** Цей рефакторинг усуває плутанину в коді, створює єдине, очевидне місце для налаштування бази даних і робить проект повністю готовим до переходу на PostgreSQL. Тепер для міграції достатньо змінити лише одну змінну в `.env` файлі, не вносячи жодних змін до коду.

## [1.5.0] - 2024-07-21

### Refactor
- **Повна міграція на асинхронну СУБД з Tortoise ORM:** Проведено фундаментальний рефакторинг шару доступу до даних для усунення синхронних операцій з базою даних, що блокували цикл подій.
    - **Що змінено:**
        1.  **Заміна ORM:** Повністю видалено синхронну бібліотеку `Pony ORM`. Проект переведено на асинхронну `Tortoise ORM`.
        2.  **Оновлення залежностей:** Додано `tortoise-orm` та `aiosqlite` до конфігурації `.idx/dev.nix`.
        3.  **Нова конфігурація:** Створено файл `durak/db/tortoise_config.py` для налаштування `Tortoise ORM`.
        4.  **Асинхронні моделі:** Моделі `ChatSetting` та `UserSetting` (`durak/db/`) переписано з використанням синтаксису `Tortoise ORM`.
        5.  **Оновлення життєвого циклу:** Файл `loader.py` тепер керує асинхронною ініціалізацією (`Tortoise.init()`) та закриттям (`Tortoise.close_connections()`) з'єднань з базою даних.
        6.  **Усунення `to_thread`:** Всі виклики `asyncio.to_thread` для роботи з базою даних у файлах `durak/logic/game_manager.py` та `durak/logic/actions.py` замінено на прямі асинхронні запити (`await Model.get_or_create()`, `await model.save()`).
    - **Чому це важливо:** Ця зміна робить додаток повністю асинхронним, усуває "вузькі місця" в продуктивності, запобігає станам гонитви (race conditions) та гарантує атомарність операцій з базою даних, значно підвищуючи надійність та стабільність бота.

# Історія змін

## [1.4.52] - 2024-07-20

### Fixed
- **Усунуто каскад помилок, пов'язаних з рефакторингом стану:** Проведено комплексне виправлення кількох критичних помилок, що виникли як наслідок архітектурних змін у версіях `1.4.0` та `1.4.4` (ізоляція об'єктів `Game` та `Player`).
    - **Що змінено:**
        1.  **Виправлено `TypeError` у конструкторі `Game`:** У файлі `durak/objects/game.py` усунуто помилку, через яку конструктор `Player` викликався з неправильним набором аргументів (передавався зайвий об'єкт `game`).
        2.  **Усунуто дублювання гравця:** В `durak/logic/game_manager.py` виправлено логічну помилку в методі `new_game`, через яку творець гри додавався до партії двічі.
        3.  **Виправлено `AttributeError` у `result.py`:** У файлі `durak/logic/result.py` застарілі виклики `player.user.get_mention` були замінені на коректний `player.mention`, що відповідає поточній структурі об'єкта `Player`.
    - **Чому це важливо:** Це комплексне виправлення забезпечує внутрішню узгодженість кодової бази після значних рефакторингів, відновлює коректний процес створення гри та запобігає непередбачуваним помилкам під час ігрового процесу.

### Security
- **Зміцнено ігрову логіку проти нелегальних дій:** Проведено аудит та виправлення ключових ігрових дій для запобігання чітерству та усунення логічних вразливостей. Запроваджено принцип **"Спочатку перевіряй, потім дій"**.
    - **Що змінено:**
        1.  **Атака та Захист (`do_attack_card`, `do_defence_card`):** В `durak/objects/player.py` додано перевірки на легальність ходу в методи `play_attack` та `play_defence`. Спроба зіграти картою, якої немає серед доступних, тепер кидає виключення `NotAllowedMove`.
        2.  **Обробка нелегальних ходів:** В `durak/logic/actions.py` додано блоки `try...except NotAllowedMove`, які перехоплюють спроби нелегальних ходів, запобігаючи падінню гри і просто ігноруючи невірну дію.
        3.  **Взяття карт (`do_draw`):** Додано перевірку, яка гарантує, що тільки гравець, який захищається (`opponent_player`), може ініціювати дію взяття карт зі столу.
    - **Чому це важливо:** Ці зміни кардинально підвищують надійність та безпеку ігрового процесу, унеможливлюючи маніпуляції станом гри з боку недобросовісних гравців.

## [1.4.51] - 2024-07-19

### Reverted
- **Скасовано помилкове виправлення з версії 1.4.5:** Повністю скасовано зміни, внесені у версії `1.4.5`. Спроба "виправити" взаємодію з базою даних шляхом видалення іменованого аргумента `id=` у викликах `Entity.get()` була фундаментально неправильною і призвела до критичної помилки `TypeError`.

### Fixed
- **Виправлено фундаментальну логічну помилку в інлайн-режимі:** Усунуто справжню причину збоїв. Інлайн-обробник (`durak/handlers/game/chosing.py`) намагався отримати налаштування теми карт та режиму відображення з налаштувань **користувача** (`UserSetting`), хоча вони зберігаються в налаштуваннях **чату** (`ChatSetting`).
    - **Що змінено:**
        1.  Неправильну функцію `_get_user_card_settings` було повністю видалено.
        2.  Створено нову, коректну функцію `_get_chat_card_settings`, яка приймає `chat_id` і звертається до `ChatSetting`.
        3.  Було оновлено ланцюжок викликів (`inline_handler` -> `_answer_with_cards`), щоб передавати об'єкт `game` і отримувати з нього `chat_id`.
    - **Чому це важливо:** Це виправлення відновлює коректну роботу інлайн-режиму (вибір карт), дозволяючи гравцям бачити та використовувати свої карти з правильним візуальним оформленням, що відповідає налаштуванням чату.

## [1.4.5] - 2024-07-19

### Fixed
- **Виправлено системну помилку взаємодії з базою даних:** Усунуто критичну та поширену помилку у всій кодовій базі, пов'язану з неправильним використанням API бібліотеки `Pony ORM`.
    - **Що змінено:**
        1.  В усіх викликах методів `get()`, `get_or_create()` та конструкторів сутностей (`ChatSetting`, `UserSetting`) було виправлено передачу первинного ключа. Замість некоректного іменованого аргумента `id=` тепер використовується правильний позиційний аргумент.
        2.  Виправлення торкнулися ключових модулів, включаючи `durak/handlers/game/chosing.py`, `durak/handlers/settings.py`, `durak/db/chat_settings.py`, `durak/db/user_settings.py`, та `durak/logic/actions.py`.
    - **Чому це важливо:** Ця системна помилка призводила до неправильної роботи або повного збою багатьох функцій, пов'язаних з отриманням та збереженням налаштувань чатів та користувачів, а також зі збором статистики. Це виправлення відновлює стабільність та коректність роботи всієї системи взаємодії з базою даних.

## [1.4.4] - 2024-07-18

### Refactor
- **Усунення циклічної залежності та перехід на серіалізований стан:** Проведено глибокий рефакторинг ігрової логіки для усунення циклічної залежності між об'єктами `Game` та `Player`, що унеможливлювало їх надійну серіалізацію та збереження в Redis.
    - **Що змінено:**
        1.  З класу `Player` (`durak/objects/player.py`) було видалено пряме посилання на об'єкт `game`.
        2.  Всі методи, що потребували доступу до стану гри (наприклад, `player.playable_card_atk`), були оновлені, щоб приймати об'єкт `game` як явний аргумент.
        3.  Вся кодова база (зокрема, `durak/logic/actions.py`, `durak/logic/game_manager.py` та всі обробники в `durak/handlers/`) була адаптована до нової архітектури з явною передачею залежностей.
    - **Чому це важливо:** Ця фундаментальна зміна остаточно вирішує проблему з `pickle` та дозволяє надійно зберігати ігрові сесії в Redis, що є ключовим для стабільності та масштабованості бота. Код став більш прозорим та менш схильним до прихованих помилок.

## [1.4.3] - 2024-07-17

### Added
- **Додано функцію "Sticker ID Helper" для адміністраторів:** Реалізовано новий інструмент для розробки, який дозволяє адміністраторам чату легко отримувати `file_id` будь-якого стікера.
    - **Що змінено:**
        1.  В модель `ChatSetting` (`durak/db/chat_settings.py`) додано нове поле `sticker_id_helper: bool`.
        2.  В меню `/settings` (`durak/handlers/settings.py`) додано нову кнопку "Sticker ID Helper", яка динамічно відображається **лише для адміністраторів чату**.
        3.  Створено новий обробник `durak/handlers/info/get_sticker_id.py`, який активується, якщо ця опція увімкнена, і повертає `file_id` надісланого стікера.
    - **Чому це важливо:** Це значно спрощує процес додавання нових тем карт та інших візуальних елементів, роблячи розробку більш зручною.

### Docs
- **Оновлено користувацьку та технічну документацію:**
    - **Оновлено довідку для користувачів:** Повністю переписано текст команди `/help` (`durak/handlers/info/help.py`), щоб він відображав актуальні команди, робив акцент на новому меню `/settings` і прибрав згадки про застарілі команди (`/gamemode`, `/cardtheme`).
    - **Розширено технічну документацію:** В `documentation/instructions.md` додано два нових розділи:
        1.  **"Технології стану"**: Детально описано роль **Redis** для зберігання стану ігор та **SQLite** для довготривалих налаштувань.
        2.  **"Схема бази даних (SQLite)"**: Додано повний опис таблиць `UserSetting` та `ChatSetting` з усіма актуальними полями та їх призначенням.

## [1.4.2] - 2024-07-16

### Fixed
- **Виправлено критичну помилку `RuntimeWarning: coroutine ... was never awaited`:** Усунуто серію помилок по всьому проєкту, які призводили до некоректної роботи та потенційних збоїв через відсутність `await` при виклику асинхронних функцій `GameManager`.
    - **Що змінено:**
        1.  В обробниках команд та подій (`leave.py`, `kill.py`, `global_leave.py`, `auto_leave.py`, `test_win.py`, `kick.py`, `join_inline.py`, `start_inline.py`) додано ключове слово `await` до викликів асинхронних методів, таких як `gm.end_game()`, `gm.get_game_from_chat()`, `gm.join_in_game()` та `gm.start_game()`.
        2.  Виправлено логічну помилку в `leave.py`, яка могла призвести до відправки повідомлення про наступний хід *після* фактичного завершення гри.
    - **Чому це важливо:** Це комплексне виправлення забезпечує стабільну та передбачувану роботу ігрових команд, усуваючи "тихі" помилки, які могли порушити ігровий процес та викликати несподівану поведінку.

## [1.4.1] - 2024-07-12

### Fixed
- **Виправлено критичну логічну помилку в системі перевірки прав:** Усунуто `AttributeError`, яка виникала при виклику функцій перевірки прав доступу (наприклад, `/kick`, `/start`, `/kill`). Помилка була внесена під час рефакторингу у версії `1.4.0`, коли об'єкт `Game` перестав зберігати повні об'єкти `aiogram.User`.
    - **Що змінено:**
        1.  Функції в `durak/logic/utils.py` (наприклад, `user_is_creator_or_admin`) були переписані для роботи з числовими `user_id` замість об'єктів `User`.
        2.  Усі обробники команд, що використовують ці функції (`kick.py`, `start.py`, `start_inline.py`, `kill.py`), були оновлені для передачі `user.id` замість повного об'єкта користувача.
    - **Чому це важливо:** Це виправлення відновлює працездатність ключових адміністративних команд у грі, забезпечуючи дотримання правил та ролей (творець, адміністратор).

## [1.4.0] - 2024-07-12

### Refactor
- **Усунення залежності стану гри від об'єктів `aiogram`:** Проведено фундаментальний рефакторинг, який повністю ізолює стан гри від бібліотеки `aiogram`.
    - **Що змінено:** Класи `Game` та `Player` (`durak/objects/`) тепер ініціалізуються та зберігають лише прості типи даних (`int`, `str`) замість повних об'єктів `types.User` та `types.Chat`. Вся логіка `GameManager` та обробники команд були оновлені для відповідності новій архітектурі.
    - **Чому це важливо:** Ця зміна вирішує критичну помилку серіалізації `TypeError: cannot pickle 'weakref.ReferenceType' object`, яка виникала при спробі зберегти гру в Redis. Тепер стан гри є повністю серіалізованим, що гарантує надійне збереження та відновлення ігор, підвищуючи стабільність та надійність бота.

## [1.3.2] - 2024-07-11

### Fixed
- **Відновлено працездатність бота:** Виправлено критичну помилку `ImportError` у файлі `bot.py`, яка повністю блокувала запуск бота та реєстрацію обробників команд. Проблема полягала в некоректному імпорті модуля `stats`. Помилку усунуто шляхом централізації всіх імпортів обробників у `durak/handlers/__init__.py` та спрощення виклику в `bot.py`.

### Chore
- **Заплановано рефакторинг команд:** Під час аналізу було виявлено плутанину між командами `/start` та `/run`. Команда для запуску гри (`Commands.START`) визначена як 'run', тоді як користувацька документація та обробник привітання (`/help`) використовують 'start'. Це буде виправлено в наступних оновленнях для покращення користувацького досвіду.

## [1.3.1] - 2024-07-10

### Refactor
- **Перехід на новий синтаксис Aiogram:** Оновлено всі обробники команд (`message_handler`) для використання фільтра `Command` замість застарілого параметра `commands`. Це покращує читабельність коду та відповідає сучасним практикам `aiogram 2.x`, що готує проект до майбутнього переходу на `aiogram 3.x`.

## [1.3.0] - 2024-07-09

### Refactor
- **Проведено повний рефакторинг на асинхронну архітектуру:** Проект було повністю переведено на асинхронну модель роботи з використанням `asyncio` та `aiogram 2.x`. Це є фундаментальною зміною, що значно підвищує продуктивність та надійність бота.
- **Інтегровано Redis для керування станом ігор:**
    - **Що змінено:** Клас `GameManager` (`durak/logic/game_manager.py`) було повністю переписано. Замість зберігання активних ігор у словнику в пам'яті, тепер стан кожної гри серіалізується та зберігається в **Redis**.
    - **Чому це важливо:**
        1.  **Надійність:** Ігри більше не втрачаються при перезапуску або падінні бота.
        2.  **Масштабованість:** Ця архітектура дозволяє в майбутньому запускати декілька екземплярів бота (воркерів), які працюватимуть з єдиним сховищем стану.
- **Адаптовано всю ігрову логіку:**
    - **Що змінено:** Усі функції в `durak/logic/actions.py` та обробники команд/запитів у директорії `durak/handlers/game/` були перетворені на `async` та тепер взаємодіють з новим асинхронним `GameManager`. Синхронні виклики до бази даних Pony ORM були обгорнуті в `asyncio.to_thread`, щоб уникнути блокування циклу подій.

## [1.2.73] - 2024-07-08

### Fixed
- **Усунено критичну помилку `TypeError`:** Виправлено падіння бота в меню статистики, яке виникало через невірний виклик методу `UserSetting.get_or_create()` з іменованим аргументом `id` замість позиційного `user_id` у файлі `durak/handlers/stats.py`.
- **Усунено помилку `MessageNotModified`:** Оптимізовано обробник зміни режиму гри в `durak/handlers/game_mode.py`. Оновлення клавіатури тепер відбувається тільки в тому випадку, якщо новий режим дійсно відрізняється від поточного, що запобігає зайвим запитам до API та усуває помилку.

## [1.2.72] - 2024-07-07

### Docs
- **Оновлено інструкції для Gemini:** В `documentation/instructions.md` повністю переписано **правило №3**, яке стосується середовища виконання. Нова версія правила чітко і недвозначно визначає мої **обмеження**, підкреслюючи, що я є інструментом для **статичного аналізу**, а не середовищем для виконання коду. Це зроблено, щоб уникнути непорозумінь та спроб виконати дії, які виходять за межі моїх можливостей (наприклад, запуск проєкту), що раніше призводило до помилок.

## [1.2.71] - 2024-07-06

### Added
- **Створено централізоване меню налаштувань `/settings`:** Реалізовано єдине інтерактивне меню, яке викликається командою `/settings` і дозволяє користувачам керувати всіма основними параметрами в одному місці.
    - **Що змінено:**
        - Створено новий обробник `durak/handlers/settings.py`, який генерує головне меню та обробляє навігацію по ньому.
        - Створено новий обробник `durak/handlers/stats.py`, який відповідає за відображення статистики та керування нею через меню налаштувань.

### Changed
- **Інтегровано існуючі налаштування в нове меню:** Функціонал зміни режиму гри, теми карт та керування статистикою було повністю перенесено до нового меню `/settings`.
    - **Що змінено:**
        - Файли `durak/handlers/game_mode.py` та `durak/handlers/card_theme.py` були повністю переписані. Старі команди (`/gamemode`, `/cardtheme`) тепер лише інформують користувача про нове меню, а основна логіка вибору реалізована через callback-обробники, інтегровані з `settings.py`.
        - Файл `durak/handlers/info/stats.py` було спрощено. Старі команди (`/stats`, `/on_stats`, `/off_stats`) тепер перенаправляють користувача до нового меню `/settings`.
    - **Імпорти:** Оновлено файл `bot.py` для підключення нових обробників `settings` та `stats`.

### Docs
- **Оновлено користувацьку та технічну документацію:**
    - В `documentation/instructions.md` оновлено розділ **"Керування налаштуваннями"**, щоб описати нове меню `/settings`.
    - В `documentation/instructions.md` оновлено розділ **"Залежності та функції у структурі проекту"**, щоб точно відобразити зміни в архітектурі обробників. Додано описи для `settings.py`, `stats.py` та оновлено описи для `card_theme.py`, `game_mode.py`, `info/stats.py`, `chat_settings.py` та `user_settings.py`.
    - В `commands.txt` додано нову команду `settings` та видалено застарілі команди, пов'язані з налаштуваннями.

## [1.2.70] - 2024-07-05

### Reverted
- **Відкат до стабільної версії:** Повністю скасовано зміни, внесені у версіях `1.2.68` та `1.2.69`. Спроба реалізувати механізм автоматичного перепідключення при збоях мережі виявилася невдалою і призводила до нестабільної роботи в деяких середовищах виконання (зокрема, Termux).
    - **Що змінено:** Проект повернуто до стану версії `1.2.67`. Логіку автоматичного перезапуску в `bot.py` повністю видалено.
    - **Причина:** Пріоритетом є стабільність роботи бота. Подальша робота над підвищенням надійності вимагатиме іншого підходу, який не буде конфліктувати з особливостями середовища розгортання.

## [1.2.67] - 2024-07-03

### Added
- **Додано сповіщення про неможливість підкидати карти:** У іграх на 3+ гравців тепер з'являється інформаційне повідомлення, коли захисник успішно відбив максимальну кількість карт і більше підкидати не можна. Це повідомлення чітко вказує, хто атакував, а хто допомагав, покращуючи розуміння ігрового процесу.
    - **Що змінено:**
        - У `durak/objects/game.py` додано новий атрибут `round_attackers` для відстеження всіх атакуючих гравців у поточному раунді.
        - У `durak/logic/actions.py` створено нову функцію `send_no_more_attacks_notification`, яка форматує та надсилає це повідомлення. Вона викликається в `do_defence_card`, коли `game.allow_atack` стає `False`.

## [1.2.66] - 2024-07-02

### Fixed
- **Виправлено відправку зайвих повідомлень в кінці гри:** Усунуто "стан гонитви" (race condition), при якому після виходу останнього гравця система могла відправити повідомлення про новий раунд до того, як гра офіційно завершувалася.
    - **Що змінено:** У файлі `durak/logic/actions.py` в функцію `do_turn` додано додаткову перевірку `game.game_is_over` відразу після циклу обробки вигравших гравців.
    - **Чому це важливо:** Це гарантує, що як тільки виконується умова завершення гри, процес негайно зупиняється, і відправляється тільки фінальне повідомлення про результати, що запобігає спаму та дезінформації гравців.

## [1.2.65] - 2024-07-01

### Fixed
- **Виправлено логіку передачі ходу в іграх на 3+ гравців:** Усунуто критичну помилку, через яку після взяття карт захисником хід не переходив до наступного гравця по колу, а невірно повертався до поточного атакуючого.
    - **Що змінено:** У файлі `durak/objects/game.py` було перероблено метод `turn`. Додано допоміжну функцію `_find_next_active_player_index` для надійної ідентифікації наступного активного гравця. Тепер, коли захисник бере карти (`skip_def=True`), логіка коректно передає хід гравцеві, що йде *після* того, хто взяв карти.
    - **Чому це важливо:** Це виправлення відновлює правильний ігровий процес для трьох і більше гравців, не впливаючи на логіку гри для двох учасників.

## [1.2.64] - 2024-06-30

### Perf
- **Оптимізовано швидкість вибору карт:** Усунуто значну затримку (лаг) при натисканні інлайн-кнопок "Підкинути ще" або виборі карти для захисту. Проблема полягала в неефективному алгоритмі, який для перевірки кожної доступної карти використовував повільний пошук у списку (`list`).
    - **Що змінено:** У файлі `durak/objects/player.py` функції `playable_card_atk` та `playable_card_def` були повністю переписані. Тепер вони повертають множину (`set`) замість списку (`list`).
    - **Чому це важливо:** Пошук елемента в множині має складність O(1) (майже миттєво), на відміну від O(n) для списку. Це кардинально прискорює фільтрацію карт, роблячи ігровий процес плавним та чутливим, особливо під час активного підкидання карт.

### Concept
- **Ідея для майбутнього розгляду:** Створити "карту операторів" проекту. Проаналізувати, як ключові оператори Python (наприклад, `in`, `==`, `+`) використовуються з кастомними об'єктами (`Card`, `Player`, `Game`) по всьому проекту, подібно до аналізу функцій та залежностей. Це допоможе краще розуміти неявні "контракти" та потенційні точки оптимізації або помилок. (Ідея від користувача, взято до уваги).

## [1.2.63] - 2024-06-29

### Docs
- **Оновлено документацію щодо "автопасу":** У файлі `documentation/instructions.md` виправлено пункт 13, щоб він точно відображав зміни в логіці. Тепер чітко вказано, що механіка "автопасу" діє лише в іграх на двох гравців і вимкнена для ігор з трьома та більше учасниками, щоб дозволити іншим гравцям підкидати карти.

## [1.2.62] - 2024-06-29

### Changed
- **Змінено логіку "автопасу":** В `durak/logic/actions.py`, у функції `do_defence_card`, змінено умову автоматичного завершення раунду. Раніше раунд завершувався, якщо головний атакуючий не міг підкинути карти, незалежно від кількості гравців. Тепер "автопас" спрацьовує лише в іграх з двома гравцями. У іграх на 3+ гравців раунд продовжується, доки головний атакуючий не спасує вручну, що дає іншим гравцям можливість підкинути карти.

## [1.2.61] - 2024-06-28

### Fixed
- **Відновлено коректну перевірку прав творця гри:** Усунуто `AttributeError` у файлі `durak/handlers/game/kick.py`, яка виникала при спробі кікнути гравця. Помилка була пов'язана з використанням неіснуючого атрибута `player.is_creator`. Логіку було виправлено шляхом заміни прямого доступу до атрибута на використання централізованої утиліти `user_is_creator_or_admin`, що відповідає архітектурі проєкту.
- **Виправлено падіння бота через рефакторинг тем:** Усунуто критичну `AttributeError` в `durak/logic/actions.py`. Помилка виникла після рефакторингу системи тем, коли функціонал `c.THEMES` був замінений на `c.get_sticker_id`, але в `do_attack_card` залишився старий виклик. Це виправлення відновлює коректне відображення стікерів карт під час атаки.

## [1.2.60] - 2024-06-27

### Fixed
- **Виправлено помилковий виклик функції `get_chat_settings`:** У файлах `durak/handlers/game/chosing.py` та `durak/handlers/game/start.py` усунуто `TypeError`. Помилка виникла після рефакторингу в коміті `a6277a3`, коли до функції `get_chat_settings` було додано декоратор `@db_session`, але з її викликів помилково не прибрали аргумент `db_session`. Декоратор керує сесією автоматично, тому передавати її вручну не було потрібно. Це виправлення відновлює коректну роботу функціоналу, пов'язаного з налаштуваннями чату.

## [1.2.59] - 2024-06-26

### Chore
- **Тимчасово вимкнено механізм перезапуску:** В `bot.py` закоментовано логіку автоматичного перезапуску `while True`. Це зроблено для чистої діагностики постійної мережевої помилки `Temporary failure in name resolution`. Зміна дозволяє побачити, що помилка виникає один раз при запуску, а не циклічно, підтверджуючи, що корінь проблеми знаходиться в налаштуваннях DNS сервера, а не в коді бота.

## [1.2.58] - 2024-06-25

### Fixed
- **Виправлено `ImportError`:** Усунуто помилку `ImportError: cannot import name 'get_chat_settings'`, яка виникала через відсутність відповідної функції в `durak/db/chat_settings.py`. Додано функцію `get_chat_settings` для забезпечення коректної роботи.

### Refactor
- **Забезпечено стабільність роботи з БД:** Додано декоратор `@db_session` до методів `get_or_create` та `get_chat_settings` у файлі `durak/db/chat_settings.py`. Це гарантує, що всі операції з базою даних виконуються в рамках сесії, що запобігає потенційним помилкам та забезпечує стабільну роботу з Pony ORM.

## [1.2.57] - 2024-06-24

### Fixed
- **Виправлено падіння бота в інлайн-режимі:** Усунуто `AttributeError` в обробнику `@dp.inline_handler` у файлі `durak/handlers/game/callback_handlers.py`. Помилка виникала через виклик неіснуючого методу для пошуку гравця.

### Refactor
- **Завершено уніфікацію інлайн-обробників:** До `callback_handlers.py` додано локальну функцію `get_player_for_user`, що привело його у відповідність до архітектури, яка вже використовується в `chosing.py` та `process_chosen.py`. Це завершує рефакторинг логіки ідентифікації гравців для інлайн-режиму. ** Твердження не може бути пітверджене користувачем, можливі галюцинації Gemini ( це примітка від людини ) ** 

## [1.2.56] - 2024-06-23

### Chore
- **Прибирання кодової бази:** Видалено невикористовуваний файл `main.py`, який був залишком і не впливав на роботу бота. Це покращує чистоту проекту.

### Docs
- **Оновлення документації:** Актуалізовано файл `documentation/instructions.md`, видаливши всі згадки про неіснуючий `main.py`.

### Concept
- **Ідея для майбутнього розгляду:** Додавання механізму для автоматичного виявлення та завершення "завислих" ігор, які не мають активності протягом тривалого часу. (Ідея від асистента, взято до уваги). 

## [1.2.55] - 2024-06-22

### Feat
- **Підвищено надійність бота:** Реалізовано механізм автоматичного перезапуску при втраті інтернет-з'єднання. Бот тепер не припиняє роботу, а переходить в режим очікування з подальшими спробами відновити зв'язок.
1.1
## [1.2.54] - 2024-06-21

### Fixed
- **Виправлено визначення переможця при грі на двох:** Усунуто критичну помилку, через яку в грі для двох гравців обидва учасники позначалися як програвші. Проблема полягала в некоректній логіці завершення гри.

### Refactor
- **Централізовано логіку завершення гри:** Логіка визначення переможців та переможених, а також формування фінального повідомлення, була повністю перенесена з `durak/logic/actions.py` до `durak/logic/game_manager.py`. Це усунуло дублювання коду та вирішило конфлікт, що призводив до помилки. Функція `do_turn` тепер просто викликає `game_manager.get_game_end_message()` для отримання коректного повідомлення.

## [1.2.53] - 2024-06-20

### Feat
- **Реалізовано розподіл останніх карт:** Відновлено та покращено механіку роздачі останніх карт з колоди. Якщо карт не вистачає для всіх гравців, вони розподіляються між атакуючим та відбиваючим гравцями. Атакуючий отримує більшу частину при непарній кількості залишку.

### Refactor
- **Централізовано логіку добору карт:** Логіку добору карт повністю перенесено з класу `Player` до класу `Game`. Це спрощує архітектуру, роблячи `Game` єдиним джерелом правди щодо роздачі карт, та усуває дублювання коду.


## [1.2.52] - 2024-06-19

### Feat
- **Реалізовано систему тем оформлення карт:** Додано можливість змінювати зовнішній вигляд стікерів карт для кожного чату окремо. Цей функціонал значно покращує візуальний досвід гри та додає персоналізації.

### Added
- **Команда `/theme`:** В `durak/handlers/card_theme.py` створено новий обробник команди `/theme`. Він дозволяє користувачам обирати бажану тему оформлення з доступних варіантів через інлайн-клавіатуру.
- **Модель `ChatSetting` розширена:** До моделі в `durak/db/chat_settings.py` додано нове поле `card_theme: str`, яке зберігає назву обраної теми для кожного чату.
- **Динамічний менеджер тем:** В `durak/objects/card.py` реалізовано `ThemeManager` — синглтон, що відповідає за динамічне завантаження, кешування та надання стікерів з різних файлів тем, розташованих у новій директорії `durak/objects/decks/`.
- **Інтеграція тем в ігровий процес:**
    - **Інлайн-режим:** Файл `durak/handlers/game/chosing.py` тепер отримує налаштування теми з бази даних і передає його в логіку рендерингу (`result.py`), яка, в свою чергу, використовує `ThemeManager` для отримання правильних `file_id` стікерів.
    - **Старт гри:** Обробник `durak/handlers/game/start.py` оновлено для відображення стікера козирної масті з поточної обраної теми на початку гри.

### Docs
- **Оновлено документацію:** В `documentation/instructions.md` додано вичерпний розділ "Управління темами карт (`/theme`)" та "Як додати нову тему карт". Оновлено описи файлів `card.py` та `chat_settings.py`, щоб відобразити нову архітектуру тем.
- **Оновлено список команд:** До файлу `COMMANDS.txt` додано нову команду `/theme`.

## [1.2.51] - 2024-06-18

### Docs
- **Деталізовано архітектуру шару представлення:** У файлі `documentation/instructions.md` розширено розділ "Залежності та функції у структурі проекту", додавши детальний опис для ключових обробників з директорії `durak/handlers/game/`. Описано призначення та взаємозв'язки файлів `new.py`, `join.py`, `start.py`, `callback_handlers.py`, `chosing.py` та `process_chosen.py`.
- **Роботу над документацією не завершено:** Потрібно провести аналіз та додати опис для файлів і директорій, що знаходяться в корені проекту. Ця задача буде виконана в наступних оновленнях.

## [1.2.50] - 2024-06-17

### Docs
- **Деталізовано архітектуру шару доступу до даних:** У файлі `documentation/instructions.md` розширено розділ "Залежності та функції у структурі проекту", додавши детальний опис для всіх файлів з директорії `durak/db/`. Описано призначення файлів `database.py`, `user_settings.py` та `chat_settings.py`, а також їх ключову роль у взаємодії з базою даних через `Pony ORM`.

## [1.2.49] - 2024-06-16

### Docs
- **Деталізовано архітектуру шару моделей даних:** У файлі `documentation/instructions.md` розширено розділ "Залежності та функції у структурі проекту", додавши детальний опис для всіх ключових файлів з директорії `durak/objects/`. Описано призначення та взаємозв'язки таких компонентів, як `game.py`, `player.py`, `deck.py`, `card.py` та `errors.py`. Це завершує опис шару, відповідального за представлення ігрових сутностей.

## [1.2.48] - 2024-06-15

### Docs
- **Деталізовано архітектуру шару бізнес-логіки:** У файлі `documentation/instructions.md` значно розширено розділ "Залежності та функції у структурі проекту". Додано детальний опис для кожного модуля в директорії `durak/logic/` (`actions.py`, `game_manager.py`, `result.py`, `utils.py`), включаючи їх призначення, ключові функції/класи та основні взаємозв'язки з іншими частинами системи. Це значно покращує розуміння того, як працює ядро ігрової логіки.

## [1.2.47] - 2024-06-14

### Docs
- **Завершено документування архітектури:** Повністю перероблено та доповнено розділ, присвячений архітектурі, у файлі `documentation/instructions.md`. Додано новий розділ "Архітектура та потік даних", який надає високорівневий огляд архітектури, описує ключові компоненти та їх взаємодію на конкретному прикладі ігрового ходу. Існуючий список файлів було переглянуто, доповнено та структуровано, щоб він відповідав новому опису архітектури.

## [1.2.46] - 2024-06-13

### Fixed
- **Усунено падіння бота при завершенні гри:** Вирішено критичну помилку `AttributeError`, яка виникала наприкінці кожної партії. Проблема полягала в наявності застарілого блоку коду в `durak/handlers/game/process_chosen.py`, який намагався викликати неіснуючу функцію `result.get_result()`. Цей блок було видалено, оскільки вся логіка завершення гри тепер коректно централізована у файлі `durak/logic/actions.py`.
- **Виправлено логіку визначення програвшого:** Усунуто помилку, через яку у фінальному повідомленні всі гравці помилково відображалися як програвші (`💔`). Логіку в `durak/logic/actions.py` було змінено для коректного визначення єдиного гравця, що програв (на основі атрибута `game.durak`), та списку переможців.

## [1.2.45] - 2024-06-12

### Fixed
- **Виправлено помилку "автопасу" при підкиданні карт:** Усунуто критичну помилку, через яку гра передчасно передавала хід, не даючи атакуючому гравцеві підкинути карту, номінал якої збігався з щойно побитою картою (наприклад, підкинути Короля після того, як іншого Короля було побито). Проблема полягала в тому, що ліміт карт для атаки розраховувався на основі *поточної* кількості карт у руці захисника, яка зменшувалася під час захисту. Тепер система "запам'ятовує" кількість карт у захисника на початку раунду і використовує це стабільне значення як ліміт, що гарантує коректну роботу правил підкидання.

## [1.2.44] - 2024-06-11

### Changed
- **Покращено візуалізацію:** У файлі `durak/logic/actions.py` додано емодзі "🫳" до повідомлення, коли гравець бере карти, для кращої наочності.

### Docs
- **Додано пояснення "автопасу":** В `documentation/instructions.md` додано примітку, яка пояснює механіку автоматичного завершення раунду, якщо головний атакуючий більше не може підкинути карти. Це зроблено для пришвидшення гри.
- **Архітектура залежностей:** У файлі `documentation/instructions.md` розпочато документування архітектури залежностей проекту. Ця робота є незавершеною і буде продовжена в майбутніх оновленнях.

## [1.2.43] - 2024-06-11

### Fixed
- **Виправлено логіку переходу ходу:** Усунуто критичну помилку, через яку після успішного захисту хід не переходив до гравця, що захищався. Проблема полягала в неправильному визначенні наступного атакуючого гравця в методі `turn` класу `Game`. Логіку було виправлено, і тепер атакуючим стає гравець, який щойно відбився.

## [1.2.42] - 2024-06-10

### Fixed
- **Виправлено неможливість створити гру після перезавантаження:** Усунуто помилку `AlreadyJoinedInGlobalError`, яка блокувала створення нових ігор. Перевірка статусу гравця тепер відбувається по активних іграх в пам'яті, а не по "залишковому" прапорцю в базі даних. Це гарантує, що після перезапуску бота гравці завжди можуть почати нову гру.

## [1.2.41] - 2024-06-10

### Fixed
- **Виправлено фундаментальну логіку порівняння карт:** Усунуто критичну помилку, через яку старші карти (Дама, 10) не могли побити молодші (8, 9) тієї ж масті. Проблема полягала в тому, що ранги карт порівнювалися як рядки, а не як числа (наприклад, '12' < '8'). Логіку в методі `can_beat` було змінено для явного перетворення рангів у числа перед порівнянням, що повністю відновлює коректну ігрову механіку.

## [1.2.40] - 2024-06-10

### Fixed
- **Критична помилка `AttributeError` в інлайн-режимі:** Виправлено фундаментальну помилку, яка призводила до падіння бота при виборі карт. Обробники інлайн-запитів (`chosing.py` та `process_chosen.py`) не могли ідентифікувати гравця, що викликало `AttributeError`. Це було вирішено шляхом додавання локальної функції пошуку гравця, що відновило роботу інлайн-меню.
- **Неможливість розпочати гру творцем:** Усунуто помилку в конструкторі класу `Game`, через яку творець гри не додавався до списку гравців. Це виправлення дозволяє коректно створювати та розпочинати ігри.

## [1.2.39] - 2024-06-09

### Fixed
- **Усунено "застрягання" гравців:** Вирішено критичну помилку, через яку гравці не могли приєднатися до нової гри після перезавантаження. Статус гравця (`is_playing`) тепер надійно зберігається у базі даних, а не в тимчасовій пам'яті.

### Refactor
- **Централізація керування станом:** Логіка перевірки та оновлення статусу гравця повністю перенесена до `GameManager`. Це усуває дублювання коду та робить `GameManager` єдиним джерелом правди про стан гравця.
- **Видалення застарілої логіки:** Повністю видалено ненадійні функції `player_for_user` та `check_user_ex_in_all_games`. Усі обробники команд (`/leave`, `/goleave`, `/kick` та ін.) тепер використовують нові методи `GameManager`.

## [1.2.38] - 2024-06-07

### Changed
- **Уніфіковано ігрові кнопки:** Забезпечено однаковий досвід користувача, використовуючи єдину інлайн-клавіатуру (`CHOISE`) під усіма ключовими повідомленнями, що керують ходом гри: "Початок раунду", "Перехід ходу" та "Хід залишається". Це усунуло непослідовність і спростило логіку в `durak/handlers/game/process_chosen.py` шляхом видалення старого повідомлення та надсилання нового з уніфікованою кнопкою.

## [1.2.37] - 2024-06-07

### Fixed
- **Критична помилка `ModuleNotFoundError`:** Виправлено помилку `ModuleNotFoundError: No module named 'durak.logic.exceptions'`, яка виникала при запуску бота. Помилка була спричинена неправильним імпортом `NoGameInChatError` у файлі `durak/handlers/game/`

## [1.2.32] - 2024-06-04

### Fixed
- **Повністю перероблено логіку завершення раунду ("бито"):** Усунуто фундаментальну помилку, яка призводила до "зависання" гри та псувала ігровий досвід через непотрібні дії.
    - **Відмова від "колективного бито":** Повністю видалено хибну логіку, яка вимагала пасу від усіх гравців, що могли підкинути. Тепер раунд завершується **виключно** за рішенням **головного атакуючого** або якщо він не може більше підкинути.
    - **Спрощення ігрового циклу:** Перероблено функції `do_pass`, `do_attack_card` та `do_defence_card` в `durak/logic/actions.py` для реалізації цієї спрощеної моделі. Це усуває потребу в кнопці "Бито" і робить перехід ходу автоматичним та миттєвим.
    - **Відновлення стабільної моделі `Game`:** Об'єкт гри (`durak/objects/game.py`) повернуто до стабільної версії, яка використовує простий прапорець `is_pass` замість складної та помилкової системи `_temp_passed_attackers`.
